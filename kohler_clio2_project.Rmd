---
title: "Kohler Project"
description: |
  A new article created using the Distill format.
author:
  - name: Michael kohler
    url: http://michaelskohler.com/personal_website/index.html
date: "`r Sys.Date()`"
bibliography: bib.bib
output: distill::distill_article
---
```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(dplyr)
library(leaflet)
library(USAboundaries)
library(sf)
library(corrplot)
library(ggcorrplot)
library(distill)

pop_1850 <- read_csv("mapping_files/pop_1850.csv")
total_1860 <- read_csv("mapping_files/total_1860.csv")
race_1860 <- read_csv("mapping_files/race_1860.csv")
election_1860 <- read.csv("mapping_files/1860_election_returns.csv")


VA_pop_1850 <- pop_1850 %>% 
  rowwise() %>%
  mutate(total_black = sum( free_black, total_slave, na.rm = TRUE)) %>% 
    select(state = STATE,
           county = COUNTY,
           year = YEAR,
           full_name,
           total_pops = total_population,
           total_black,
           free_black,
           total_slave,
           total_white) %>% 
  filter(state == "Virginia")

VA_pop_1860 <- race_1860 %>% 
  left_join(total_1860) %>% 
  rowwise() %>%
  mutate(total_black = sum( free_black, total_slave, na.rm = TRUE)) %>% 
  select(state = STATE,
           county = COUNTY,
           year = YEAR,
           full_name,
           total_pops = total_population,
           total_black,
           free_black,
           total_slave,
           total_white) %>% 
  filter(state == "Virginia")

VA_pop_50_60 <- right_join(VA_pop_1850, VA_pop_1860, by = "county")

counties_va_1860 <- us_counties("1860-06-01", states = "Virginia")

centroids_va_1860 <- counties_va_1860 %>% 
    st_centroid()
  
VA_pop <- VA_pop_50_60 %>%
  select(county,
         full_name = full_name.y,
         total_1850 = total_pops.x,
         black_1850 = total_black.x,
         slave_1850 = total_slave.x,
         white_1850 = total_white.x,
         total_1860 = total_pops.y,
         black_1860 = total_black.y,
         slave_1860 = total_slave.y,
         white_1860 = total_white.y) %>%
  mutate(slave_diff = sum(slave_1860 - slave_1850, na.rm = FALSE)) %>% 
  mutate(diff_percent = round(slave_diff / slave_1850, 3)) %>% 
  mutate(percent_slave_1860 = round(slave_1860 / total_1860, 3)) %>% 
  mutate(percent_slave_1850 = round(slave_1850 / total_1850, 3)) %>%
  mutate(percent_change = percent_slave_1860 - percent_slave_1850)


VA_data <- VA_pop %>% 
  left_join(election_1860, by = "full_name") %>% 
  select(-county.y,
         county = county.x)

VA_shapes <- counties_va_1860 %>% 
  left_join(VA_data, by = "full_name")

scale_range <- c(1.5, -1.5)

slave_dif_colors <- colorNumeric("RdBu", domain = scale_range)
slave_per_colors <- colorNumeric(palette = "Purples", domain = VA_data$percent_slave_1860)
bell_per_colors <- colorNumeric(palette = "Oranges", domain = VA_data$bell_pct)
breck_per_colors <- colorNumeric(palette = "Greens", domain = VA_data$breckinridge_pct)
doug_per_colors <- colorNumeric(palette = "Blues", domain = VA_data$douglas_pct)
linc_per_colors <- colorNumeric(palette = "Reds", domain = VA_data$lincoln_pct)
```

  Indeed, soon after Virginia seceded and effectively joined the Confederacy on April 17th, 1861, one of the first actions done by the secessionist government was to send state militia to secure various strategic areas in Northwestern Virginia. On May 3rd the secessionist governorsent militia units to the strategic rail hub of Grafton (now in Taylor County, WV), with other units being sent to secure Charleston and Harper's Ferry, including troops commanded by the soon-to-be-famous Thomas J. Jackson (himself a Northwesterner from what is now Clarksburg, WV).



























```{r, fig.cap="Slave Population by County"}

leaflet(VA_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~slave_per_colors(percent_slave_1860),
              fillOpacity = 1,
              color = "black", weight = 1,
              label = ~county,
              popup = ~paste0(county, " County: ", 100 * percent_slave_1860, "% enslaved")) %>% 
  addLegend("bottomright", pal = slave_per_colors, values = VA_data$percent_slave_1860,
    title = "",
    labFormat = labelFormat(suffix = "%",
                            transform = function(x) {x * 100}),
    opacity = 1
  )


```

```{r, fig.cap="Votes for Lincoln in 1860 in Virginia"}

centroids_va_1860 <- counties_va_1860 %>%
  st_centroid()

VA_points <- centroids_va_1860 %>% 
  left_join(VA_data, by = "full_name") %>% 
  filter(lincoln > 0)

pop_scale <- function(x, max_radius = 20) {
  x %>% 
    sqrt() %>% 
    scales::rescale_max(to = c(0, max_radius))
}

leaflet(VA_points) %>% 
  addTiles() %>% 
  addCircleMarkers(radius = ~pop_scale(lincoln),
                   label = ~county,
                   popup = ~paste0(county, " County: ", lincoln, " votes"),
                   color = "red")

```


```{r, fig.cap="Change in Slave Population, 1850-1860"}
knitr::opts_chunk$set(echo = FALSE)

leaflet(VA_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~slave_dif_colors(diff_percent),
              fillOpacity = 1,
              color = "black", weight = 1,
              label = ~county,
              popup = ~paste0(county, " County: ", 100 * diff_percent, "%, a change of ", slave_diff, " slaves")) %>% 
  addLegend("bottomright", pal = slave_dif_colors, values = scale_range,
    title = "",
    labFormat = labelFormat(suffix = "%",
                            transform = function(x) {x * 100}),
    opacity = 1
  )
```
More stuff.


```{r, layout="1-page",fig.cap="Votes for John Bell (Constitutional Union Party) in 1860 in Virginia"}
knitr::opts_chunk$set(echo = FALSE)

leaflet(VA_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~bell_per_colors(bell_pct),
              fillOpacity = 1,
              color = "black", weight = 1,
              label = ~county,
              popup = ~paste0(county, " County: ", bell, " votes, ", 100 * bell_pct, "%")) %>% 
  addLegend("bottomright", pal = bell_per_colors, values = VA_data$bell_pct,
    title = "Bell",
    labFormat = labelFormat(suffix = "%",
                            transform = function(x) {x * 100}),
    opacity = 1
  )
```

```{r, fig.cap="Votes for John C. Breckinridge (Southern Democratic Party) in 1860 in Virginia"}
knitr::opts_chunk$set(echo = FALSE)

leaflet(VA_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~breck_per_colors(breckinridge_pct),
              fillOpacity = 1,
              color = "black", weight = 1,
              label = ~county,
              popup = ~paste0(county, " County: ", breckinridge, " votes, ", 100 * breckinridge_pct, "%")) %>% 
  addLegend("bottomright", pal = breck_per_colors, values = VA_data$breckinridge_pct,
    title = "Breckinridge",
    labFormat = labelFormat(suffix = "%",
                            transform = function(x) {x * 100}),
    opacity = 1
  )
```

```{r, fig.cap="Votes for Steven A. Douglas (Democratic Party) in 1860 in Virginia"}
knitr::opts_chunk$set(echo = FALSE)

leaflet(VA_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~doug_per_colors(douglas_pct),
              fillOpacity = 1,
              color = "black", weight = 1,
              label = ~county,
              popup = ~paste0(county, " County: ", douglas, " votes, ", 100 * douglas_pct, "%")) %>% 
  addLegend("bottomright", pal = doug_per_colors, values = VA_data$douglas_pct,
    title = "Douglas",
    labFormat = labelFormat(suffix = "%",
                            transform = function(x) {x * 100}),
    opacity = 1
  )
```

```{r, fig.cap="Votes for Abraham Lincoln (Republican Party) in 1860 in Virginia"}
knitr::opts_chunk$set(echo = FALSE)

leaflet(VA_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~linc_per_colors(lincoln_pct),
              fillOpacity = 1,
              color = "black", weight = 1,
              label = ~county,
              popup = ~paste0(county, " County: ", lincoln, " votes, ", 100 * lincoln_pct, "%")) %>% 
  addLegend("bottomright", pal = linc_per_colors, values = VA_data$lincoln_pct,
    title = "Lincoln",
    labFormat = labelFormat(suffix = "%",
                            transform = function(x) {x * 100}),
    opacity = 1
  )
```

Talk talk talk

Talky talky talky talky
```{r, fig.cap="Correlation Matrix for Reducing Counties. Here we explore the correlation between the vote percentage for the four 1860 Presidential Candidates in Virginia with the percentage of each county which was then enslaved as well as the percentage by which the enslaved population had reduced in the decade prior to the vote."}
knitr::opts_chunk$set(echo = FALSE)



VA_vote <- VA_data %>%
  filter(diff_percent < 0 ) %>% 
  mutate(slavery_reduction = diff_percent * -1) %>% 
  select("% Enslaved" = percent_slave_1860,
         "Slavery % Reduction" = slavery_reduction,
         "John Bell %" = bell_pct,
         "Breckinridge %" = breckinridge_pct,
         "Douglas %" = douglas_pct,
         "Lincoln %" = lincoln_pct)

VA_vote.cor = cor(VA_vote)

ggcorrplot(VA_vote.cor, title = "Correlation Matrix for Reducing Counties", lab = TRUE)




```

Talky talky talky talky
```{r, fig.cap="Correlation Matrix for Increasing Counties. As above, but here we look only at counties in which the slave population had increased in the previous decade. The correlation between increased slave populations and vote prefences in 1860 seems slight, perhaps suggesting that in these counties voting was determined more by preexisting partisanship."}
knitr::opts_chunk$set(echo = FALSE)



VA_vote <- VA_data %>% 
  filter(diff_percent > 0 ) %>% 
  select("% Enslaved" = percent_slave_1860,
         "Slavery % Increase" = diff_percent,
         "John Bell %" = bell_pct,
         "Breckinridge %" = breckinridge_pct,
         "Douglas %" = douglas_pct,
         "Lincoln %" = lincoln_pct)

VA_vote.cor = cor(VA_vote)

ggcorrplot(VA_vote.cor, title = "Correlation Matrix for Increasing Counties", lab = TRUE)




```



